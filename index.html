<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search</title>
    <style>
        .logo {
            font-size: 2em;
        }

        .logo > ul {
            padding: 0;
            margin: 0;
        }

        .logo > ul > li {
            list-style-type: none;
        }

        footer {
            font-size: 0.7em;
            width: 100%;
            bottom: 1em;
            position: fixed;
            text-align: center;
            color: #555555;

        }

        a {
            text-decoration: none;
        }

        footer a:link {
            color: #555555;
        }

        footer a:visited {
            color: #555555;
        }

        footer p {
            font-size: 0.5em;
        }

        .input-group {
            display: inline-block;
        }

        .input-group > div {
            float: left;
            font-size: 0;
            box-shadow: 0 1px 4px 0 rgba(133, 133, 133, .50);
        }

        .input-group > div > input {
            border: 0;
            height: 3em;
        }

        .input-group > div > input[type="button"] {
            color: #ffffff;
            background: cadetblue;
        }

        #group {
            display: none;
        }

        #group li {
            margin-top: 1em;
        }

        .content {
            text-align: center;
        }
    </style>
</head>
<body>
<div>
    <div id="app" class="row">
        <div class="content">
            <div class="logo">
                <span v-html="logo"></span>
                <ul id="group" v-html="group">
                </ul>
            </div>
            <div class="input-group">
                <div>
                    <input v-model="input_text" type="text" oninput="suggestion()"  list="sug_list">
                    <datalist id="sug_list" v-html="v_sug_list">
                    </datalist>
                    <input value="Search" type="button" onclick="search()">
                </div>
            </div>
        </div>
    </div>
</div>
<footer>
    <a href="https://github.com/hezhuowei/I-only-want-to-search">Github</a>
    <p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></p>
</footer>
<script id="jsonp"></script>
<script src="js/jquery-3.2.1.min.js"></script>
<script src="js/vue.min.js"></script>
<script>
    if (!localStorage.config) {
        localStorage.config = JSON.stringify({
            "default_search_engine": "Baidu"
        })
    }
    const engine_list = {
        "Google": "https://www.google.com/search?q=",
        "Baidu": "https://m.baidu.com/s?word=",
        "Sougo": "https://m.sogou.com/web/searchList.jsp?keyword=",
        /*"Bing": "https://www.bing.com/search?q=",
        "360": "https://m.so.com/s?q=",*/
        "Zhihu": "https://zhihu.sogou.com/zhihuwap?query="
    };
    let config = JSON.parse(localStorage.config);
    let vm = new Vue({
        el: '#app',
        data: {
            v_sug_list:"",
            input_text: "",
            logo: config.default_search_engine,
            group: ""
        }
    });
    const set_default_engine = (str) => {
        config.default_search_engine = str;
        localStorage.config = JSON.stringify(config);
        update_group(str);
        vm.$data.logo = str;
        $('#group').stop();
        $('#group').slideToggle(150);
        $('footer').fadeToggle(150);
    };
    const update_group = (default_engine) => {
        let item = '';
        for (let i in engine_list) {
            if (i !== default_engine) {
                item += `<li onclick="set_default_engine('${i}')">${i}</li>`
            }
        }
        vm.$data.group = item;
    };
    const search = () => {
        window.location.href = engine_list[config.default_search_engine] + vm.$data.input_text;
    };
    /*jsonp跨域调用百度suggestion*/
    const suggestion = () => {
        setTimeout(()=>{
            const old_jsonp=document.getElementById("jsonp");
            document.body.removeChild(old_jsonp);
            const wd = vm.$data.input_text;
            const new_jsonp=document.createElement('script');
            new_jsonp.id='jsonp';
            new_jsonp.src=`https://sp0.baidu.com/5a1Fazu8AA54nxGko9WTAnF6hhy/su?wd=${wd}`;
            document.body.appendChild(new_jsonp)
        },100)
    };
    /*百度suggestion回调*/
    window.baidu = {
        "sug": (req) => {             /*返回json*/
            const arr = req.s;
            vm.$data.v_sug_list='';
            for (let i in arr) {
                const wd = arr[i];
                vm.$data.v_sug_list += `<option value="${wd}"></option>`;
            }
        }
    };
    /*service worker*/
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js', {scope: '/'}
        ).then(
            (reg) => {
                console.log(`service worker scope is ${reg.scope}`);
            }
        ).catch((err) => {
            console.log(`service worker registration failed with${err}`)
        });
    }
    $(document).ready(function () {
        update_group(config.default_search_engine);
        $('input').focus(
            () => {
                $('footer').hide();
            }
        );
        $('input').blur(
            () => {
                $('footer').show();
            }
        );
        $('.logo').find('span').click(() => {
            $('#group').stop();
            $('#group').slideToggle(150);
            $('footer').fadeToggle(150);
        });
        $('input').keyup((e) => {
            if (e.keyCode == 13) {
                search();
            }

        })
    });
</script>
</body>
</html>
